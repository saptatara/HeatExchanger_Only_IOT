{% extends "base.html" %}
{% load static %}

{% block content %}
<h2>{{ device.name }} - Sensor Data</h2>

{% if error %}
  <p style="color:red">{{ error }}</p>
{% endif %}

<h3>Recent Data</h3>
{% if sensor_readings %}
<ul>
  {% for reading in sensor_readings %}
    <li>
      {{ reading.sensor_config.sensor_label }}: {{ reading.value }}
      ({{ reading.created_at|date:"M d, Y, h:i a" }})
    </li>
  {% endfor %}
</ul>
{% else %}
<p>No recent sensor readings available.</p>
{% endif %}

<h3>Sensor Graphs</h3>
{% if sensor_data_json %}
  {% comment %}
    We'll generate the chart containers dynamically in JS,
    so we just need a placeholder div
  {% endcomment %}
  <div id="charts-container"></div>
{% else %}
<p>No sensor data available to display charts.</p>
{% endif %}

<!-- JSON data for charts -->
<script>
  const sensorData = JSON.parse('{{ sensor_data_json|escapejs }}');

  const chartsContainer = document.getElementById("charts-container");

  Object.keys(sensorData).forEach(label => {
    const data = sensorData[label];
    if (!data || data.length === 0) return;

    // Create canvas dynamically
    const div = document.createElement("div");
    div.style.marginBottom = "40px";

    const h4 = document.createElement("h4");
    h4.innerText = label;
    div.appendChild(h4);

    const canvas = document.createElement("canvas");
    canvas.id = `chart-${label}`;
    canvas.height = 200;
    div.appendChild(canvas);

    chartsContainer.appendChild(div);

    const ctx = canvas.getContext("2d");

    new Chart(ctx, {
      type: 'line',
      data: {
        labels: data.map(d => d.timestamp),
        datasets: [{
          label: label,
          data: data.map(d => d.value),
          borderColor: 'rgba(75, 192, 192, 1)',
          backgroundColor: 'rgba(75, 192, 192, 0.2)',
          fill: false,
          tension: 0.1,
          pointRadius: 2
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: true } },
        scales: {
          x: { display: true, title: { display: true, text: 'Time' } },
          y: { display: true, title: { display: true, text: 'Value' } }
        }
      }
    });
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

